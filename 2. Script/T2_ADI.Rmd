---
title: "Taller 1 - Regresión e Interpretación Causal"
author: "Nicolas Jacome Velasco, Zaira Alejandra Garcia Bernal"
date: "2025-08-16"
output:
  pdf_document:
    latex_engine: xelatex
    extra_dependencies: ["adjustbox"]
---

# Evaluación de Impacto

## Taller 1: Variables Instrumentales

### 0. Carga de datos y paquetes

```{r}
# Instalar 
if (!requireNamespace("pacman", quietly = TRUE)) {
  install.packages("pacman")
}

# Cargar los paquetes necesarios
pacman::p_load(haven, plm, skimr, dplyr, ggplot2, AER,
               lmtest, sandwich)

library(haven)
library(plm)
library(skimr)
library(dplyr)
library(haven)
library(ggplot2)
library(AER)
library(lmtest)
library(sandwich)
library(stargazer)
```

```{r}
# Carga de datos .dta
url_data <- "https://github.com/zagarciab/Talleres-Evaluacion-de-Impacto/raw/main/3.%20Data/oil_windfall_sin10perc.dta"

base <- read_dta(url_data)
```

### 0.1 Exploración de los datos

```{r}
# Estructura de datos y estadísticas
str(base)
skim(base) # sin missing values


## Convertir a factor variables categoricas
var_factor <- c("sigla")

base <- base %>%
  mutate(across(all_of(var_factor), as.factor))
```

### 1. Especificación de la regresión

Escriban la especificación principal de los autores (en niveles) y describan cada una de sus variables explicativas. :

$$Outcome_{m}=β_0+β_1 OilRev_{m}+X_{m}Γ+λ_s+ ε_{is}$$ Donde la variable dependiente:

-   $Outcome_{m}$ gasto público per cápita del municipio *m* en el año 2000, en cada rubro: (Educación y Cultura; Salud y Saneamiento; Transporte; Transferencias sociales).

Donde los parámetros y variables de interés son:

-   $OilRev_{m}$ ingresos públicos per cápita provenientes del petróleo (regalías/participaciones) del municipio m.

-   $β_1$ son los parámetros de interés que responden a la pregunda de investigación. Efecto causal de interés (cambio en gasto por 1 real brasilero adicional per cápita en ingresos petroleros).

Variables de control:

-   $X_{smgt}Γ$ corresponde a un vector de controles y sus coeficientes correspondientes. Este vector contiene:

    -   $DistFederalCapital_{m}$ distancia a la capital federal.
    -    $DistStateCapital_{m}$ distancia a la capital estatal.
    -    $Latitud_{m}$ coordenada geográfica.
    -    $Logitude_{m}$ coordenada geográfica.
    -    $StateCapital_{m}$ indicador si es capital estatal.
    -    $Coastal_{m}$ indica si el municipio está en la costa.
    -    $Onshore_{m}$ indica si tiene capos petroleros en tierra.

Donde, los efectos fijos son:

-   $λ_s$ corresponde a efectos fijos a nivel del estado, para controlar por todas las características no observadas y constantes en el tiempo que comparten los municipios de un mismo estado.

Términos adicionales:

-   $β_0$ es la constante del modelo.
-   $ε_{is}$ corresponde al término del error que captura todas las variables no observadas a nivel municipal que afectan el gasto en cada rubro.

### 2. Intuición de variables instrumentales (VI)

¿Cuál es la intuición detrás de implementar Variables Instrumentales (VI) en vez de Mínimos Cuadrados Ordinarios (MCO)? En este escenario: Mencione al menos un sesgo del cual podríamos estar preocupados si interpretamos los efectos por MCO de manera causal. ¿Cuáles son los supuestos necesarios para que VI nos permita recuperar el efecto causal de interés? ¿Son creíbles los supuestos? Argumenten

-   Se implementa VI en lugar de MCO, ante la posible correlación existente entre los factores no observables que determinan el gasto a nivel municipal, generando endogeneidad en el ingreso petrolero per cápita. Lo anterior, para evitar que el β_1 sea sesgado.

-   En ese sentido, los posibles sesgos que se pueden presentar ante la estimación por MCO puede darse por una correlación positiva entre los ingresos iniciales de los municipios y la asignación de las regalías petroleras.

-   Los supuestos necesarios para determinar una buena VI son dos principalmente:

    -   Relevancia: donde el intrumento debe estar correlacionado con la variable de interes.

    -   Exclusión: el instrumento debe afectar el gasto público unicamente a través de los ingresos petroleros (sin considerar otro canal). Es este supuesto también es necesario incluir la independencia de las variables.

        Estos supuestos si suelen ser creibles, sin embargo, representan retos para los investigadores para realmente encontrar una VI que cumpla con estos.

### 3. Presentación de resultados primera etapa

En una tabla, presenten los resultados de estimar la primera etapa de la metodología de Variables Instrumentales.¿Es el instrumento relevante y fuerte? Contesten esta pregunta usando los dos criterios recomendados en la clase magistral

```{r}
# 1. Filtrar muestra: solo municipios costeros y offshore (onshore = 0)
base_sub <- subset(base, coastal == 1 & onshore == 0)

# 2. Primera etapa: Oil revenues explicado por el instrumento + controles
first_stage <- lm(mun_budget_revenue2000_pred_c ~ oilandgasvalue2000_cap + 
                    dist_federal_capital1998 + dist_state_capital1998 +
                    latitude1998 + longitude1998 + state_capital +
                    factor(sigla),
                  data = base_sub)

# 3. Resumen con errores robustos
summary_first_stage <- coeftest(first_stage, vcov = vcovHC(first_stage, type = "HC1"))
print(summary_first_stage)

# 4. Calcular F de significancia individual del instrumento:
#    F = (t estadístico)^2 del coeficiente del instrumento
t_instrument <- summary_first_stage["oilandgasvalue2000_cap", "t value"]
F_instrument <- t_instrument^2
cat("Estadístico F del instrumento (primera etapa):", F_instrument, "\n")

# 5. Interpretación práctica
if (F_instrument > 10) {
  cat("El instrumento es fuerte según la regla Stock-Yogo (F > 10).\n")
} else {
  cat("El instrumento puede ser débil (F < 10), hay riesgo de sesgo.\n")
}

# Tabla de resultados
stargazer(first_stage, type = "text",
          title = "Primera Etapa - Variables Instrumentales",
          dep.var.labels = "Ingresos Petroleros Municipales (2000)",
          covariate.labels = c("Oilandgas Value 2000 (capita)",
                               "Distancia Capital Federal",
                               "Distancia Capital Estatal",
                               "Latitud",
                               "Longitud",
                               "Capital Estatal",
                               "Efectos fijos por Estado"),
          omit = "factor", # para no mostrar todos los efectos fijos
          omit.labels = "Efectos Fijos de Estado",
          no.space = TRUE)
```

El instrumento `oilandgasvalue2000_cap`es estadísticamente significativo en la primera etapa (coeficiente = 0.034; p \< 0.001), lo que evidencia su **relevancia individual**, cumpliendo con el primer criterio recomendado.

Adicionalmente, el estadístico F = 88.16 supera ampliamente el umbral de 10 establecido en la literatura (Stock–Yogo), confirmando que el instrumento es **fuerte** y no presenta el problema de debilidad instrumental que podría sesgar las estimaciones de IV.

En conclusión, el instrumento cumple con ambos criterios: es relevante y fuerte. Por lo tanto, es adecuado para ser utilizado en la metodología de variables instrumentales y permite avanzar hacia la segunda etapa para identificar el efecto causal del ingreso petrolero sobre el gasto público municipal.

### 4. Presentación de resultados por VI

En una tabla, presenten e interpreten los resultados de estimar por VI el efecto de (mayores) ingresos públicos (producto del petróleo) sobre el gasto público reportado en el año 2000 en Educación y Cultura, Salud y Sanitización, Transporte y Transferencias Sociales.

```{r}

```

### 5. Presentación de resultados por VI

En una tabla, presenten e interpreten los resultados de estimar por VI el efecto de (mayores) ingresos públicos (producto del petróleo) sobre las variables efectivas de bienestar. En particular, sobre proporción de personas que no viven en favelas en 2000 y  el número de salones por millón de habitantes en el 2005. ¿Qué indican sus resultados? ¿Mayores ingresos públicos resultan en niveles del bienestar medido a través de estas variables?. En texto describa los resultados para la primera variable

```{r}

```
